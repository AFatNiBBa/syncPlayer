
<!DOCTYPE html>
<html>
	<head>
        <title> Video </title>
	    <style>
            video
            {
                width: 50%;
                height: 50%;
            }
        </style>
        <script>
            var lock = 0;
            secure = () => window.location.protocol == "https:";
            send = type => (lock == 0) && socket.send(JSON.stringify({
                type,
                time: video.currentTime,
            }));

            function load()
            {
                const video = window.video = document.querySelector("video");
                const socket = window.socket = new WebSocket(`ws${ secure() ? "s" : "" }://${ window.location.hostname }${ window.location.hostname == "localhost" ? ":3000" : "" }`);
                video.onplay = x => send("play");
                video.onpause = x => send("pause");
                video.ontimeupdate = x => send("current");

                const id = setInterval(() => socket.send("alive"), 1000);
                socket.onclose = x => clearInterval(id);
                socket.onmessage = async x => {
                    lock++;
                    const promises = [];
                    try
                    {
                        const obj = JSON.parse(x.data);
                        console.log(obj);
                        if (obj.type == "play" && video.paused) promises.push(video.play());
                        if (obj.type == "pause" && !video.paused) promises.push(video.pause());
                        if (Math.abs(video.currentTime - obj.time) > 1) video.currentTime = obj.time;
                    }
                    catch { }
                    await Promise.all(promises);
                    lock--; // Le funzioni "play" e "pause" sono asincrone, perci√≤ "lock" veniva diminuito prima della loro esecuzione
                };
            }
        </script>
	</head>
	<body onload="load()">
        <video controls>
            <!-- Da Google Drive -->
            <source src="https://blob-eu-central-1-nwsekq.s3.eu-central-1.amazonaws.com/sara/10/1039/1039af42-dca2-4ad6-b25f-799e50da0a25.bin?response-content-disposition=attachment%3B%20filename%3D%22AOT4x8.mp4%22&response-content-type=video%2Fmp4&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAI75SICYCOZ7DPWTA%2F20210211%2Feu-central-1%2Fs3%2Faws4_request&X-Amz-Date=20210211T103650Z&X-Amz-SignedHeaders=host&X-Amz-Expires=1800&X-Amz-Signature=f651b4fd13733d1bf1fd9e443f42cbb1b4e6aa8859907704ba52f62054605ec9" type='video/mp4'>
        </video>
	</body>
</html>