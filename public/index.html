
<!DOCTYPE html>
<html>
	<head>
        <title> Sync Player </title>
        <script>
            var lock = 0;
            const url = new URL(window.location.href);
            const proxy = new Proxy(url.searchParams, {
                get: (t, k) => t.get(k),
                set: (t, k, v) => t.set(k, v)
            });

            //| Carica la pagina sicura perchè "navigator.clipboard" sta solo su quella
            if (!navigator.clipboard)
            {
                url.protocol = "https:";
                window.location.href = url.href;
            }
            
            //| Manda un pacchetto di aggiornamento con password, tempo corrente e tipo del pacchetto
            function send(type)
            {
                if (lock == 0) socket.send(JSON.stringify({
                    type,
                    time: video.currentTime,
                    pass: proxy.pass
                }));
            }

            //| Universally Unique ID v4
            function uuid()
            {
                return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, c => {
                    const r = Math.random() * 16 | 0;
                    return (
                        c == "x"
                        ? r
                        : (r & 0x3 | 0x8)
                    ).toString(16);
                }); 
            }

            proxy.room ??= uuid();
            proxy.link ??= "https://filetransfer.io/data-package/eX4xyCEC/download"
            function load()
            {
                const video = window.video = $("video")[0];
                const socket = window.socket = new WebSocket(`ws${ window.location.protocol == "https:" ? "s" : "" }://${ window.location.hostname }${ window.location.hostname == "localhost" ? ":3000" : "" }`);

                video.onplay = x => send("play");
                video.onpause = x => send("pause");
                video.ontimeupdate = x => send("current");

                const id = setInterval(() => socket.send("alive"), 1000);
                socket.onclose = x => clearInterval(id);
                socket.onopen = x => socket.send(proxy.room);
                socket.onmessage = async x => {
                    lock++;
                    const promises = [];
                    try
                    {
                        const obj = JSON.parse(x.data);
                        console.log(obj);
                        if (obj.type == "play" && video.paused) promises.push(video.play());
                        if (obj.type == "pause" && !video.paused) promises.push(video.pause());
                        if (Math.abs(video.currentTime - obj.time) > 1) video.currentTime = obj.time;
                    }
                    catch { }
                    await Promise.all(promises);
                    lock--; // Le funzioni "play" e "pause" sono asincrone, perciò "lock" veniva diminuito prima della loro esecuzione
                };

                //| Se modifichi i parametri ti dice che c'è da salvare
                $('input[type="text"]').on("change", () => {
                    const submit = $('button[type="submit"]');
                    submit.removeClass("btn-secondary").addClass("btn-warning");
                    submit[0].innerHTML = 'Aggiorna<span class="text-danger font-weight-bold">*</span>';
                });

                //| Abilita la descrizione durante l'hover
                $("[title]").tooltip();
            }
        </script>
	</head>
	<body onload="load()">
        <input id="buffer" class="invisible" />
        <div class="container-fluid mt-5">
            <div class="row justify-content-center">
                <div class="col-lg-5 col-sm-10">
                    <video controls class="w-100">
                        <script>
                            document.writeln(`<source type="video/mp4" src="${ proxy.link }">`);
                        </script>
                    </video>
                </div>
                <div class="col-lg-5 col-sm-10">
                    <form>
                        <script>
                            const data = [ [ "room", "Stanza", "Per guardare un video insieme dovete avere tutti la stessa." ], [ "link", "Link Diretto Video", "Potete averlo diverso: Il sito sincronizza lo stesso." ], [ "pass", "Password", "Il primo che la setta comanda (Insime agli altri che hanno la stessa)." ] ];
                            for(const [ name, label, dex ] of data) document.writeln(`
                                <div class="form-group">
                                    <label for="${ name }">
                                        <h4> ${ label } </h4>
                                    </label> <br>
                                    <input type="text" name="${ name }" value="${ proxy[name] ?? "" }" placeholder="Vuoto" class="form-control">
                                    <small class="form-text text-muted"> ${ dex } </small>
                                </div>
                            `);
                        </script>
                        <button type="submit" title="Applica le Impostazioni." class="btn btn-secondary"> Aggiorna </button>
                        <input type="button" value="Admin" title="Condividi il tuo Link." class="btn btn-danger" onclick='navigator.clipboard.writeText(url.href)' />
                        <input type="button" value="Utente" title="Condividi un link che non include la Password." class="btn btn-primary" onclick='{
                            const out = new (url.constructor)(url.href);
                            out.searchParams.delete("pass");
                            navigator.clipboard.writeText(out.href); // Per copiare sulla clipboard
                        }' />
                    </form>
                </div>
            </div>
        </div>
        
        <!-- JQuery -->
        <script src="./lib/jquery.js"></script>

        <!-- Bootstrap -->
        <script src="./lib/bootstrap/js/bootstrap.js"></script>
        <script src="./lib/bootstrap/js/bootstrap.bundle.js"></script>
        <link rel="stylesheet" href="./lib/bootstrap/css/bootstrap.css" />
        <link rel="stylesheet" href="./lib/bootstrap/css/bootstrap-grid.css" />
        <link rel="stylesheet" href="./lib/bootstrap/css/bootstrap-reboot.css" />
	</body>
</html>